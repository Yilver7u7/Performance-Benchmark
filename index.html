<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JS Performance Benchmark</title>
    <link rel="stylesheet" href="./index.css">
</head>


<body>
    <main class="container">
      <div class="content">
        <h2>Global</h2>
  
        <textarea id="global" class="code" rows="1">const data = [...Array(1000).keys()]</textarea>
  
        <h2>Test cases</h2>
        <div class="test-cases">
          <article class="test-case">
            <header>
              <span class="test-id">1</span>
              <span class="ops"></span>
            </header>
  
            <textarea class="code" rows="1">data.find(x => x == 100)</textarea>
          </article>
  
          <article class="test-case">
            <header>
              <span class="test-id">2</span>
              <span class="ops"></span>
            </header>
  
            <textarea class="code" rows="1">data.find(x => x == 200)</textarea>
          </article>
  
          <article class="test-case">
            <header>
              <span class="test-id">3</span>
              <span class="ops"></span>
            </header>
  
            <textarea class="code" rows="1">data.find(x => x == 400)</textarea>
          </article>
  
          <article class="test-case">
            <header>
              <span class="test-id">4</span>
              <span class="ops"></span>
            </header>
  
            <textarea class="code" rows="1">data.find(x => x == 800)</textarea>
          </article>
        </div>
  
        <button class="send-button">Testear ðŸ’»</button>
  
      </div>
      <aside class="chart-container">
        <svg class="chart" viewBox="0 0 200 300">
          <rect class="bar" x="20" y="-300" width="5" height="300" fill="green"></rect>
          <rect class="bar" x="70" y="-300" width="5" height="50" fill="yellow"></rect>
          <rect class="bar" x="120" y="-300" width="5" height="80" fill="orange"></rect>
          <rect class="bar" x="170" y="-300" width="5" height="100" fill="red"></rect>
        </svg>
  
        <div class="percentages">
          <span class="percentage">100%</span>
          <span class="percentage">40%</span>
          <span class="percentage">60%</span>
          <span class="percentage">80%</span>
        </div>
      </aside>
    </main>

    <script type="module">
        const $globalCode = document.querySelector('#global');
        const $sendButton = document.querySelector('.send-button');
        const $bars = document.querySelectorAll('.bar');
        const $percentages = document.querySelectorAll('.percentage');

        const COLORS = ['green', 'yellow', 'orange', 'red', 'purple']

        async function runTestCase(){
            // Where is the magic work ðŸ§™
            const $testCases = document.querySelectorAll('.test-case');
            
            $bars.forEach(bar => bar.setAttribute('height', 0))
            $percentages.forEach(percentage => percentage.textContent = '')
            
            const globalCode = $globalCode.value
            

            
            /*Lo que sucede aqui es que termina saturando el hilo de trabajo
            */
            async function runTest({ code, data }) {
                const worker = new Worker('worker.js')
                worker.postMessage({ code, data, duration: 1000 })

                // Set the value of each of percentages
                $bars.forEach(bar => bar.setAttribute('height', 0))
                
            //     return new Promise( resolve => {
            //     worker.onmessage = event => {
            //         console.log('El worker dice:', event.data)
            //         resolve(event.data);
            //     }
            // })

                const { resolve, promise } = Promise.withResolvers()
                worker.onmessage = event => { resolve(event.data) }
                return promise
            }

            //Podemos traer cada uno de los elementos de una seccion especifica
            const promises = Array.from($testCases).map(async (testCase, index) => {
                const $code = testCase.querySelector('.code');
                const $ops = testCase.querySelector('.ops');

                // obtenermos el valor de la etiquera y lo modificamos
                const codeValue = $code.value;
                $ops.textContent = 'Cargando...'
                console.log( codeValue )

                const result = await runTest({ code: codeValue, data: globalCode })
                
                $ops.textContent = `${result}ops`
                console.log( result)
                
                return result
            })

            const results = await Promise.all(promises)
            // console.log("EL mas grande",maxOps)
            const maxOps = Math.max(...results)

            const sortedResults = results
            .map((result, index) => ({ result, index }))
            .sort((a, b) => b.result - a.result)

            console.log({ sortedResults })

            results.forEach((result, index) => {
            const bar = $bars[index]
            const percentage = $percentages[index]

            const indexColor = sortedResults.findIndex(x => x.index === index)
            const color = COLORS[indexColor]

            const height = result / maxOps * 300 // 300 is the height of the chart
            bar.setAttribute('height', height)
            bar.setAttribute('fill', color)

            const percentageValue = Math.round(result / maxOps * 100)
            percentage.textContent = `${percentageValue}%`
            })

        }

        //run test cases on init
        runTestCase();

        $sendButton.addEventListener('click', () => {
            runTestCase();
        })

    </script>

  </body>
</html>